# ============================================================
# LASER TRIANGULATION POSE ESTIMATION SYSTEM CONFIGURATION
# ============================================================

# System Geometry (all measurements in METERS)
geometry:
  camera:
    position: [0.0, 0.0, 0.0]  # Origin (world frame)
    optical_axis: [0.0, 0.0, 1.0]  # Points forward (+Z)
    
  laser_mems:
    position: [0.10, 0.0, 0.0]  # 10cm right of camera
    laser_exit_to_mems: 0.005  # 5mm internal spacing (ignore in code)
    effective_origin: [0.10, 0.0, 0.0]  # Use for triangulation
    
  baseline: 0.10  # Camera to laser distance (meters)
  working_distance: 0.40  # Nominal object distance (meters)
  working_volume:
    x_range: [-0.15, 0.15]  # ±15cm lateral
    y_range: [-0.15, 0.15]  # ±15cm vertical  
    z_range: [0.35, 0.50]   # 35-50cm depth

# Camera Specifications
camera:
  model: "e-CAM25_CUONX"
  sensor: "AR0234CS"
  resolution: [1920, 1200]  # pixels
  pixel_size: 3.0e-6  # 3.0 micrometers
  sensor_size: [5.76e-3, 3.6e-3]  # meters (5.76mm x 3.6mm)
  
  # Lens (ESTIMATED - will be calibrated with real hardware)
  lens:
    focal_length_mm: 6.0  # Assumed 6mm M12 lens
    type: "M12"
    
  # Intrinsics (ESTIMATED based on 6mm lens)
  intrinsics:
    fx: 2000.0  # focal length X (pixels)
    fy: 2000.0  # focal length Y (pixels)
    cx: 960.0   # principal point X
    cy: 600.0   # principal point Y
    distortion: [0.0, 0.0, 0.0, 0.0, 0.0]  # [k1, k2, p1, p2, k3]
    
  fov:
    horizontal_deg: 51.0  # Approximate for 6mm lens
    vertical_deg: 32.0

# Laser Specifications
laser:
  type: "dot"  # ASSUMED (confirm with actual laser)
  wavelength_nm: 650  # ASSUMED red laser
  power_mw: 5  # Typical laser pointer
  divergence_mrad: 1.0  # Beam divergence
  beam_diameter_mm: 1.0  # At exit

# MEMS Mirror Specifications (from S43671 datasheet)
mems:
  model: "S43671"
  mirror_diameter_mm: 5.0
  mechanical_angle_range_deg: [-1.0, 1.0]  # ±1° per axis
  bias_voltage: 80  # Volts
  max_voltage_x: 153  # Volts
  max_voltage_y: 152  # Volts
  resonant_freq_hz: 1292
  
  # Scanning parameters
  scan:
    angle_range_deg: [-2.0, 2.0]  # Optical angle (2× mechanical)
    grid_size: [64, 64]  # 64×64 = 4096 positions
    pattern: "raster"  # sweep X, step Y
    angular_step_deg: 0.0625  # 4°/64 steps
    
  # Timing (for real system)
  timing:
    settling_time_ms: 5  # Mirror settling
    exposure_time_ms: 10  # Camera exposure
    transfer_time_ms: 5   # Image transfer

# Point Cloud Specifications
point_cloud:
  target_points: 2048  # Standard for PointNet++
  format: "XYZ"  # Just coordinates (no RGB/normals)
  dtype: "float32"
  normalization:
    method: "center_and_scale"  # Center at origin, scale to unit sphere
    frame: "object_centered"

# Training Data Generation
training_data:
  dataset_size:
    samples_per_class: 10000
    classes: ["cube", "cylinder", "complex"]
    augmented_samples: 20000
    total: 50000
    
  split:
    train: 0.7   # 35,000 samples
    val: 0.15    # 7,500 samples
    test: 0.15   # 7,500 samples
    
  objects:
    cube:
      size_range: [0.12, 0.18]  # 12-18cm (±20%)
    cylinder:
      radius_range: [0.06, 0.09]  # 6-9cm
      height_range: [0.16, 0.24]  # 16-24cm
    complex:
      cad_file: "data/cad/custom_object.stl"
      
  pose_variation:
    position:
      x_range: [-0.10, 0.10]  # ±10cm
      y_range: [-0.10, 0.10]  # ±10cm
      z_range: [0.35, 0.50]   # 35-50cm depth
    rotation:
      roll_range_deg: [-30, 30]
      pitch_range_deg: [-30, 30]
      yaw_range_deg: [-180, 180]  # Full rotation
      
  noise_model:
    pixel_noise_sigma: 1.0  # Pixels (laser line detection)
    mems_angle_noise_sigma: 0.01  # Degrees
    point_noise_sigma: 0.002  # Meters (2mm in 3D)
    dropout_rate: 0.15  # 15% random point dropout
    outlier_rate: 0.02  # 2% outliers
    
  storage:
    format: "HDF5"
    compression: "gzip"
    path: "data/synthetic/dataset.h5"

# AI Model Configuration
model:
  architecture: "PointNet++"
  backbone: "MSG"  # Multi-Scale Grouping
  
  input:
    points: 2048
    channels: 3  # XYZ only
    
  output:
    format: "7D"  # [x, y, z, qw, qx, qy, qz]
    position_dims: 3
    orientation_dims: 4  # Quaternion
    
  layers:
    set_abstraction:
      - {n_points: 512, radius: 0.2, n_samples: 32}
      - {n_points: 128, radius: 0.4, n_samples: 64}
    feature_propagation:
      - {mlp: [256, 256]}
      - {mlp: [256, 128]}
    final_mlp: [128, 64, 7]

# Training Configuration
training:
  optimizer: "AdamW"
  learning_rate: 0.001
  weight_decay: 0.0001
  batch_size: 32
  epochs: 200
  early_stopping_patience: 20
  
  scheduler:
    type: "cosine_annealing"
    warmup_epochs: 5
    
  loss:
    position:
      type: "smooth_l1"
      weight: 1.0
    orientation:
      type: "geodesic_so3"
      weight: 0.1
      
  augmentation:
    random_rotation: true
    random_jitter: 0.01  # 1cm
    random_scale: [0.9, 1.1]  # ±10%
    random_dropout: [0.0, 0.2]  # 0-20%
    random_noise: 0.005  # 5mm
    
  checkpointing:
    save_best: true
    metric: "val_position_error"
    save_frequency: 10  # epochs

# Deployment Configuration
deployment:
  platform: "Jetson Orin Nano 8GB"
  optimization:
    framework: "TensorRT"
    precision: "FP16"
    batch_size: 1
    
  target_performance:
    inference_time_ms: 200
    total_pipeline_time_s: 60
    position_accuracy_mm: 5
    orientation_accuracy_deg: 3
    
  memory:
    model_size_mb: 100
    point_cloud_buffer_kb: 24
    image_buffer_mb: 5
    total_allocated_mb: 500

# Calibration Procedures
calibration:
  camera:
    method: "opencv_checkerboard"
    target: "9x6_checkerboard"
    square_size_mm: 20
    num_images: 30
    output: "config/camera_calibration.yaml"
    
  laser_plane:
    method: "planar_target_sweep"
    target_distance_m: 0.40
    mems_angles_samples: 25  # 5×5 grid
    output: "config/laser_calibration.yaml"

# File Paths
paths:
  data_root: "data/"
  synthetic_data: "data/synthetic/"
  real_data: "data/real/"
  models: "models/"
  checkpoints: "models/checkpoints/"
  tensorrt: "models/tensorrt/"
  calibration: "config/"
  logs: "logs/"